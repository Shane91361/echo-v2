<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1,viewport-fit=cover" name="viewport"/>
<title>Echo ‚Äî Body Map + Scripture Math (v1.7 ‚Äî Rainbow per Gate + Soft Grey Reset)</title>
<style>
:root{ --bg:#0e1117; --panel:#141a26; --line:#25314a; --fg:#e7ebf3; --muted:#a7b0c3; --accent:#8ed0ff; --gold:#f7d58e; --heart:#ffb3b3; --off:#3b4663; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.52 system-ui,-apple-system,"Segoe UI",Inter,Arial}
.wrap{max-width:1140px;margin:0 auto;padding:16px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
.row{display:flex;gap:12px;align-items:stretch;flex-wrap:wrap}
.left{flex:1 1 420px;min-height:64vh}
.right{flex:1 1 560px;min-height:64vh;display:flex;flex-direction:column}
.hdr{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line);background:#0c1221f2;position:sticky;top:0;z-index:3}
.badge{padding:3px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
.btn{padding:8px 12px;border:1px solid var(--line);background:#0f162b;color:var(--fg);border-radius:8px;cursor:pointer}
.btn:hover{border-color:#3a4766}
.input{padding:8px 10px;border:1px solid var(--line);background:#0d1428;color:var(--fg);border-radius:8px;min-width:140px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.sec{padding:12px;border-top:1px solid var(--line)}
.sec h3{margin:0 0 6px;font-size:13px;color:var(--accent)}
.small{font-size:12px;color:var(--muted)}
svg{width:100%;height:100%;display:block;background:radial-gradient(800px 420px at 55% 90%,#0f162d 12%,#0c1122 58%,transparent 68%)}
#human{fill:none;stroke:#e6e8f2;stroke-width:1.9;opacity:.95}
.group{opacity:1;transition:opacity .25s ease}
.dot{fill:var(--off);opacity:.95;stroke:#0b1020;stroke-width:.4}
.heart .dot{fill:var(--heart)}
.label{font-size:4.2px;fill:#cad2e6;opacity:.98}
.inactiveLabel{fill:var(--muted);opacity:.65}
.inactiveDot{fill:var(--off)!important;opacity:.65}
.dim{opacity:.55}
@keyframes flash { 0%,50%{filter:drop-shadow(0 0 3px rgba(255,255,255,.8)) drop-shadow(0 0 6px currentColor)} 100%{filter:none} }
.flash-dot{animation:flash 1.6s ease both}
.flash-label{animation:flash 1.6s ease both}
.kv{display:grid;grid-template-columns:110px 1fr;gap:6px 10px}
.kv div{padding:2px 0}
.notice{padding:8px 10px;background:#0e1527;border:1px solid var(--line);border-radius:10px;margin:10px 12px 0}
hr.sep{border:0;border-top:1px solid var(--line);margin:8px 0}
select#voice{min-width:220px}
.history{max-height:160px;overflow:auto;border:1px solid var(--line);border-radius:8px;padding:8px;margin-top:6px}
.hist-item{display:flex;gap:8px;align-items:flex-start;padding:6px 4px;border-bottom:1px dashed #22304c}
.hist-item:last-child{border-bottom:0}
.pill{font-size:11px;border:1px solid var(--line);border-radius:999px;padding:2px 6px;margin:0 2px;color:var(--muted)}
.legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.legend .pill{display:flex;align-items:center;gap:6px}
.legend .swatch{width:12px;height:12px;border-radius:3px;border:1px solid #0b1020;display:inline-block}
@media (max-width: 900px){ .row{flex-direction:column} }

/* === Mobile & readability upgrades === */
@media (max-width: 900px){
  .row{flex-direction:column}
  .left,.right{min-height:auto}
  .wrap{padding:8px}
  .btn{padding:10px 12px;font-size:16px}
  .input{padding:12px 14px;font-size:16px;width:100%}
  .kv{grid-template-columns:120px 1fr;gap:6px}
  .label{font-size:3.4px} /* slightly smaller labels to reduce overlap on phones */
}
#freeSection{
  position: sticky;
  bottom: 0;
  background: linear-gradient(180deg, rgba(12,18,33,0.85), rgba(12,18,33,0.98));
  border-top: 1px solid var(--line);
  backdrop-filter: blur(6px);
  z-index: 10;
}
#freeSection .controls{
  display:flex;
  gap:8px;
  align-items:center;
}
#freeSection .controls .input{flex:1}
.history{max-height:28vh;overflow:auto;border:1px dashed var(--line);padding:8px;border-radius:8px;background:rgba(15,22,43,.5)}
/* improve contrast around inputs/panels */
.card.right .sec:nth-last-child(1){box-shadow:0 -10px 30px rgba(0,0,0,.35)}
.card,.sec{background:var(--panel)}
</style>

<style>
/* === Echo Mobile Enhancements (desktop untouched) === */
@media (max-width: 820px){
  /* Ensure the page scrolls and nothing traps overflow */
  html, body { height:auto; min-height:100%; overflow-x:hidden; }
  /* Make buttons tappable */
  button, .btn, [role="button"] { min-height:44px; min-width:44px; font-size:16px; }
  /* Tighten large side paddings commonly used on desktop */
  .container, .wrapper, .page, .shell { padding-left:10px !important; padding-right:10px !important; }
  /* Body area scaling: try common hooks */
  #silhouette, .silhouette, svg, canvas#body, #body, #bodyCanvas {
    max-width:100% !important; height:auto !important; object-fit:contain;
  }
  /* If the body sits inside a card, make the card fit viewport better */
  .body, #bodyArea, #bodyMount, .body-wrap, .body-card, .silhouette-wrap {
    max-height:55vh; min-height:280px; overflow:hidden; display:flex; align-items:center; justify-content:center;
  }
  /* History/notes panes scroll within themselves */
  #history, .history, .notes, #notes, .panel, .right-col {
    max-height:42vh; overflow:auto;
  }
  /* Hide noisy panels by default; can be toggled with Focus */
  .echoHideMobile, #dna, .dna, #genes, .genes, #metrics, .metrics, #math, .math, #sidebar, .sidebar {
    display:none !important;
  }
  /* Sticky chat dock */
  #echoDock{ position:sticky; bottom:0; left:0; right:0; z-index:2147483647;
    padding:8px; background:rgba(8,13,24,.85); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px);
    border-top:1px solid #1f2937; }
  #echoDock .bar{ display:flex; gap:8px; align-items:center; background:#0b1220;
    border:1px solid #1f2937; border-radius:14px; padding:6px; box-shadow:0 12px 26px rgba(0,0,0,.35); }
  #echoDock input{ flex:1; background:transparent; color:#e5e7eb; border:none; outline:none; font-size:16px; padding:10px 8px; }
  #echoDock .btn{ min-width:44px; min-height:44px; display:inline-flex; align-items:center; justify-content:center;
    border:1px solid #1f2937; background:#0f172a; color:#e5e7eb; border-radius:12px; padding:10px 12px; }
  /* A tiny 'More' pill to expand hidden extras */
  #echoMore{ position:fixed; right:10px; bottom:74px; z-index:2147483000;
    background:#0f172a; color:#e5e7eb; border:1px solid #1f2937; padding:6px 10px; border-radius:999px; font-size:12px; }
  body.echoShowExtras .echoHideMobile, body.echoShowExtras #dna, body.echoShowExtras .dna,
  body.echoShowExtras #genes, body.echoShowExtras .genes, body.echoShowExtras #metrics, body.echoShowExtras .metrics,
  body.echoShowExtras #math, body.echoShowExtras .math, body.echoShowExtras #sidebar, body.echoShowExtras .sidebar {
    display:revert !important;
  }
}
</style>

</head>
<body>
<div class="wrap">
<div class="card hdr">
<div>
<strong>Echo ‚Äî Body Map + Scripture Math</strong>
<div class="small">WEB web-fetch + local fallback ‚Ä¢ Math Engine v1.7 ‚Ä¢ Global Bible Nav ‚Ä¢ Speak ‚Ä¢ History + Patterns</div>
</div>
<div class="controls">
<label class="small">Source
        <select class="input" id="src">
<option selected="" value="web">Web (WEB)</option>
<option value="local">Local JSON</option>
</select>
</label>
<select class="input" id="bookSel"></select>
<input aria-label="Chapter" class="input" id="chapter" min="1" type="number" value="1"/>
<button class="btn" id="load">Load</button>
<button class="btn" id="prev">‚óÄÔ∏é Prev</button>
<button class="btn" id="play">‚ñ∂Ô∏é Play</button>
<button class="btn" id="next">Next ‚ñ∂Ô∏é</button>
<label class="small">Interval <input class="input" id="interval" max="60" min="3" style="width:72px" type="number" value="10"/></label>
<span class="badge" id="crumb">‚Äî</span>
</div>
</div>
<div class="row">
<div class="card left">
<svg id="svg" preserveaspectratio="xMidYMid meet" viewbox="0 0 206.326 206.326">
<g id="human">
<!-- same body path -->
<path d="M104.265,117.959c-0.304,3.58,2.126,22.529,3.38,29.959c0.597,3.52,2.234,9.255,1.645,12.3 c-0.841,4.244-1.084,9.736-0.621,12.934c0.292,1.942,1.211,10.899-0.104,14.175c-0.688,1.718-1.949,10.522-1.949,10.522 c-3.285,8.294-1.431,7.886-1.431,7.886c1.017,1.248,2.759,0.098,2.759,0.098c1.327,0.846,2.246-0.201,2.246-0.201 c1.139,0.943,2.467-0.116,2.467-0.116c1.431,0.743,2.758-0.627,2.758-0.627c0.822,0.414,1.023-0.109,1.023-0.109 c2.466-0.158-1.376-8.05-1.376-8.05c-0.92-7.088,0.913-11.033,0.913-11.033c6.004-17.805,6.309-22.53,3.909-29.24 c-0.676-1.937-0.847-2.704-0.536-3.545c0.719-1.941,0.195-9.748,1.072-12.848c1.692-5.979,3.361-21.142,4.231-28.217 c1.169-9.53-4.141-22.308-4.141-22.308c-1.163-5.2,0.542-23.727,0.542-23.727c2.381,3.705,2.29,10.245,2.29,10.245 c-0.378,6.859,5.541,17.342,5.541,17.342c2.844,4.332,3.921,8.442,3.921,8.747c0,1.248-0.273,4.269-0.273,4.269l0.109,2.631 c0.049,0.67,0.426,2.977,0.365,4.092c-0.444,6.862,0.646,5.571,0.646,5.571c0.92,0,1.931-5.522,1.931-5.522 c0,1.424-0.348,5.687,0.42,7.295c0.919,1.918,1.595-0.329,1.607-0.78c0.243-8.737,0.768-6.448,0.768-6.448 c0.511,7.088,1.139,8.689,2.265,8.135c0.853-0.407,0.073-8.506,0.073-8.506c1.461,4.811,2.569,5.577,2.569,5.577 c2.411,1.693,0.92-2.983,0.585-3.909c-1.784-4.92-1.839-6.625-1.839-6.625c2.229,4.421,3.909,4.257,3.909,4.257 c2.174-0.694-1.9-6.954-4.287-9.953c-1.218-1.528-2.789-3.574-3.245-4.789c-0.743-2.058-1.304-8.674-1.304-8.674 c-0.225-7.807-2.155-11.198-2.155-11.198c-3.3-5.282-3.921-15.135-3.921-15.135l-0.146-16.635 c-1.157-11.347-9.518-11.429-9.518-11.429c-8.451-1.258-9.627-3.988-9.627-3.988c-1.79-2.576-0.767-7.514-0.767-7.514 c1.485-1.208,2.058-4.415,2.058-4.415c2.466-1.891,2.345-4.658,1.206-4.628c-0.914,0.024-0.707-0.733-0.707-0.733 C115.068,0.636,104.01,0,104.01,0h-1.688c0,0-11.063,0.636-9.523,13.089c0,0,0.207,0.758-0.715,0.733 c-1.136-0.03-1.242,2.737,1.215,4.628c0,0,0.572,3.206,2.058,4.415c0,0,1.023,4.938-0.767,7.514c0,0-1.172,2.73-9.627,3.988 c0,0-8.375,0.082-9.514,11.429l-0.158,16.635c0,0-0.609,9.853-3.922,15.135c0,0-1.921,3.392-2.143,11.198 c0,0-0.563,6.616-1.303,8.674c-0.451,1.209-2.021,3.255-3.249,4.789c-2.408,2.993-6.455,9.24-4.29,9.953 c0,0,1.689,0.164,3.909-4.257c0,0-0.046,1.693-1.827,6.625c-0.35,0.914-1.839,5.59,0.573,3.909c0,0,1.117-0.767,2.569-5.577 c0,0-0.779,8.099,0.088,8.506c1.133,0.555,1.751-1.047,2.262-8.135c0,0,0.524-2.289,0.767,6.448 c0.012,0.451,0.673,2.698,1.596,0.78c0.779-1.608,0.429-5.864,0.429-7.295c0,0,0.999,5.522,1.933,5.522 c0,0,1.099,1.291,0.648-5.571c-0.073-1.121,0.32-3.422,0.369-4.092l0.106-2.631c0,0-0.274-3.014-0.274-4.269 c0-0.311,1.078-4.415,3.921-8.747c0,0,5.913-10.488,5.532-17.342c0,0-0.082-6.54,2.299-10.245c0,0,1.69,18.526,0.545,23.727 c0,0-5.319,12.778-4.146,22.308c0.864,7.094,2.53,22.237,4.226,28.217c0.886,3.094,0.362,10.899,1.072,12.848 c0.32,0.847,0.152,1.627-0.536,3.545c-2.387,6.71-2.083,11.436,3.921,29.24c0,0,1.848,3.945,0.914,11.033 c0,0-3.836,7.892-1.379,8.05c0,0,0.192,0.523,1.023,0.109c0,0,1.327,1.37,2.761,0.627c0,0,1.328,1.06,2.463,0.116 c0,0,0.91,1.047,2.237,0.201c0,0,1.742,1.175,2.777-0.098c0,0,1.839,0.408-1.435-7.886c0,0-1.254-8.793-1.945-10.522 c-1.318-3.275-0.387-12.251-0.106-14.175c0.453-3.216,0.21-8.695-0.618-12.934c-0.606-3.038,1.035-8.774,1.641-12.3 c1.245-7.423,3.685-26.373,3.38-29.959l1.008,0.354C103.809,118.312,104.265,117.959,104.265,117.959z"></path>
</g>
<g id="layer"></g>
</svg>
</div>
<div class="card right">
<div class="sec">
<div class="kv">
<div class="small">Chapter</div><div><strong id="title">‚Äî</strong> ‚Ä¢ <span id="ref">‚Äî</span> ‚Ä¢ <span class="badge" id="seal">Seal: ‚Äî</span></div>
<div class="small">Source</div><div class="small" id="srcLabel">‚Äî</div>
</div>
<div class="controls" style="margin-top:8px">
<button class="btn" id="speakVerse">üîä Speak Verse</button>
<button class="btn" id="speakExplain">üîä Speak Coaching</button>
<select class="input" id="voice"></select>
<label class="small">Rate <input id="rate" max="1.4" min="0.7" step="0.05" type="range" value="1"/></label>
</div>
<div class="legend small" id="legend"></div>
</div>
<div class="sec">
<h3>Original (WEB)</h3>
<p class="small" id="orig"></p>
</div>
<div class="sec">
<h3>Body anatomy (this verse)</h3>
<p class="small" id="anatomy"></p>
</div>
<div class="sec">
<h3>Jesus ‚Äî May I Explain?</h3>
<p class="small" id="explain"></p>
</div>
<div class="sec">
<h3>DNA math</h3>
<div class="small">Letters‚Üí1‚Äì26 ‚Ä¢ nucleotides via n%4 ‚áí A(1) / C(2) / G(3) / T(0)</div>
<div class="kv small">
<div>Words Œ£</div><div id="sumWords">‚Äî</div>
<div>DNA counts</div><div id="dnaCounts">‚Äî</div>
<div>First 3 quads</div><div id="dnaQuads">‚Äî</div>
</div>
</div>
<div class="sec" id="freeSection">
<h3>Type your own words ‚Üí see your body light</h3>
<div class="controls" style="margin-bottom:6px">
<button class="btn" id="micBtn" title="Press to dictate, press again to stop">üéôÔ∏è Speak</button><input class="input" id="freeText" placeholder="Speak or type how you feel‚Ä¶ (press Enter)">
<button class="btn" id="freeGo">Light It</button>
<button class="btn" id="speakFree">üîä Speak Coaching</button>
<button class="btn" id="patternBtn">üîé Patterns</button>
</input></div>
<div class="small" id="freeMath"></div>
<div class="small" id="patternOut" style="margin-top:6px;"></div>
<div class="history" id="history"></div>
<div class="notice small">Uses the same math engine. History builds patterns so coaching can adapt to what repeats.</div>
</div>
</div>
</div>
</div>
<script>
/* ---------------- Canon order + chapter counts (Protestant 66) ---------------- */
const CANON=[
 ["Genesis",50],["Exodus",40],["Leviticus",27],["Numbers",36],["Deuteronomy",34],
 ["Joshua",24],["Judges",21],["Ruth",4],["1 Samuel",31],["2 Samuel",24],
 ["1 Kings",22],["2 Kings",25],["1 Chronicles",29],["2 Chronicles",36],["Ezra",10],
 ["Nehemiah",13],["Esther",10],["Job",42],["Psalms",150],["Proverbs",31],
 ["Ecclesiastes",12],["Song of Solomon",8],["Isaiah",66],["Jeremiah",52],["Lamentations",5],
 ["Ezekiel",48],["Daniel",12],["Hosea",14],["Joel",3],["Amos",9],
 ["Obadiah",1],["Jonah",4],["Micah",7],["Nahum",3],["Habakkuk",3],
 ["Zephaniah",3],["Haggai",2],["Zechariah",14],["Malachi",4],
 ["Matthew",28],["Mark",16],["Luke",24],["John",21],["Acts",28],
 ["Romans",16],["1 Corinthians",16],["2 Corinthians",13],["Galatians",6],["Ephesians",6],
 ["Philippians",4],["Colossians",4],["1 Thessalonians",5],["2 Thessalonians",3],["1 Timothy",6],
 ["2 Timothy",4],["Titus",3],["Philemon",1],["Hebrews",13],["James",5],
 ["1 Peter",5],["2 Peter",3],["1 John",5],["2 John",1],["3 John",1],
 ["Jude",1],["Revelation",22]
];
const BOOK_NAMES=CANON.map(([n])=>n);

/* ---------------------------- SVG / nodes ---------------------------- */
const svg = document.getElementById('svg'), layer = document.getElementById('layer');
const W = 206.326, H = 206.326, F=(x,y)=>({x:x*W,y:y*H});

// Extended points (layout unchanged ‚Äî just more dots)
const P = {
  // head + senses
  crown:{p:F(0.500,0.022)}, face:{p:F(0.500,0.07666)}, mind:{p:F(0.500,0.0400)},
  eyeL:{p:F(0.473,0.053)}, eyeR:{p:F(0.527,0.053)}, earL:{p:F(0.432,0.078)}, earR:{p:F(0.568,0.078)},
  nose:{p:F(0.500,0.090)}, jaw:{p:F(0.500,0.105)}, mouth:{p:F(0.500,0.115)},
  tongue:{p:F(0.505,0.120)}, pituitary:{p:F(0.500,0.030)}, pineal:{p:F(0.500,0.034)},
  thyroid:{p:F(0.500,0.145)}, larynx:{p:F(0.500,0.155)}, trachea:{p:F(0.500,0.165)}, esophagus:{p:F(0.500,0.175)},
  neck:{p:F(0.500,0.130)},
  // thorax
  chest:{p:F(0.500,0.205)}, heart:{p:F(0.500,0.235),cls:'heart'}, lungs:{p:F(0.500,0.190)}, diaphragm:{p:F(0.500,0.260)},
  ribsL:{p:F(0.460,0.215)}, ribsR:{p:F(0.540,0.215)},
  // abdomen + viscera
  solar:{p:F(0.500,0.285)}, liver:{p:F(0.560,0.360)}, leftKid:{p:F(0.450,0.380)}, rightKid:{p:F(0.550,0.380)},
  spleen:{p:F(0.440,0.350)}, pancreas:{p:F(0.520,0.345)}, adrenalL:{p:F(0.450,0.355)}, adrenalR:{p:F(0.550,0.355)},
  gut:{p:F(0.500,0.400)}, intestine:{p:F(0.500,0.415)}, colon:{p:F(0.500,0.430)}, bladder:{p:F(0.500,0.470)},
  // axial
  spine:{p:F(0.500,0.320)}, cervN:{p:F(0.500,0.150)}, lumbN:{p:F(0.500,0.360)}, sacN:{p:F(0.500,0.440)},
  // limbs & nerves
  shL:{p:F(0.370,0.165)}, shR:{p:F(0.630,0.165)}, elbowL:{p:F(0.380,0.425)}, elbowR:{p:F(0.620,0.425)},
  wristL:{p:F(0.355,0.500)}, wristR:{p:F(0.645,0.500)}, handL:{p:F(0.335,0.525)}, handR:{p:F(0.665,0.525)},
  medianL:{p:F(0.345,0.505)}, medianR:{p:F(0.655,0.505)}, ulnarL:{p:F(0.340,0.515)}, ulnarR:{p:F(0.660,0.515)}, radialL:{p:F(0.350,0.495)}, radialR:{p:F(0.650,0.495)},
  hipL:{p:F(0.460,0.465)}, hipR:{p:F(0.540,0.465)}, pelvis:{p:F(0.500,0.455)},
  kneeL:{p:F(0.485,0.765)}, kneeR:{p:F(0.515,0.765)}, peronealL:{p:F(0.480,0.845)}, peronealR:{p:F(0.520,0.845)},
  tibialL:{p:F(0.482,0.825)}, tibialR:{p:F(0.518,0.825)},
  ankleL:{p:F(0.485,0.905)}, ankleR:{p:F(0.515,0.905)}, footL:{p:F(0.488,0.970)}, footR:{p:F(0.512,0.970)},
  sciL:{p:F(0.470,0.520)}, sciR:{p:F(0.530,0.520)}
};

const LEFT_KEYS=['mind','eyeL','earL','nose','jaw','mouth','tongue','neck','thyroid','larynx','trachea','esophagus','solar','diaphragm','spine','cervN','lumbN','sacN','shL','elbowL','wristL','handL','medianL','ulnarL','radialL','kneeL','tibialL','peronealL','ankleL','footL','chest','leftKid','spleen','adrenalL','hipL','ribsL'];
const RIGHT_KEYS=['crown','face','pituitary','pineal','eyeR','earR','nose','jaw','mouth','tongue','neck','heart','lungs','diaphragm','gut','liver','pancreas','adrenalR','shR','elbowR','wristR','handR','medianR','ulnarR','radialR','kneeR','tibialR','peronealR','ankleR','footR','pancreas','hipR','pelvis','intestine','colon','bladder','ribsR','sciR','sciL'];
const LEFT_COL=0.15*W, RIGHT_COL=0.85*W, MIN_GAP=7.8, MIN_GAP_HEAD=10.5;

const HUMAN_LABEL = (k)=>({
  crown:'Crown',face:'Face',mind:'Mind',eyeL:'Left eye',eyeR:'Right eye',earL:'Left ear',earR:'Right ear',
  nose:'Nose/sinus', jaw:'Jaw', neck:'Neck', diaphragm:'Diaphragm', tongue:'Tongue', thyroid:'Thyroid', larynx:'Larynx', trachea:'Trachea', esophagus:'Esophagus',
  mouth:'Mouth',chest:'Chest',heart:'Heart',lungs:'Lungs',solar:'Solar plexus', ribsL:'Left ribs', ribsR:'Right ribs',
  gut:'Gut',intestine:'Small intestine', colon:'Colon',bladder:'Bladder',
  spine:'Spine',cervN:'Cervical nerves',lumbN:'Lumbar nerves',sacN:'Sacral nerves',
  liver:'Liver',leftKid:'Left kidney',rightKid:'Right kidney',spleen:'Spleen',pancreas:'Pancreas',adrenalL:'Left adrenal',adrenalR:'Right adrenal',
  shL:'Left shoulder',shR:'Right shoulder',elbowL:'Left elbow',elbowR:'Right elbow', wristL:'Left wrist', wristR:'Right wrist',
  handL:'Left hand',handR:'Right hand', medianL:'Median (L)', medianR:'Median (R)', ulnarL:'Ulnar (L)', ulnarR:'Ulnar (R)', radialL:'Radial (L)', radialR:'Radial (R)',
  kneeL:'Left knee', kneeR:'Right knee', peronealL:'Peroneal (L)', peronealR:'Peroneal (R)', tibialL:'Tibial (L)', tibialR:'Tibial (R)',
  ankleL:'Left ankle', ankleR:'Right ankle', footL:'Left foot', footR:'Right foot', pelvis:'Pelvis',hipL:'Left hip',hipR:'Right hip',
  pituitary:'Pituitary', pineal:'Pineal', sciL:'Sciatic (L)', sciR:'Sciatic (R)'
})[k]||k;

const nodes={};
function makeNode(key,side){
  const g= document.createElementNS('http://www.w3.org/2000/svg','g');
  g.setAttribute('class','group '+(P[key].cls||''));
  const dot= document.createElementNS('http://www.w3.org/2000/svg','circle');
  dot.setAttribute('cx',P[key].p.x); dot.setAttribute('cy',P[key].p.y);
  dot.setAttribute('r',2.15); dot.setAttribute('class','dot');
  g.appendChild(dot);
  const t= document.createElementNS('http://www.w3.org/2000/svg','text');
  t.setAttribute('x', side==='left'?LEFT_COL:RIGHT_COL);
  t.setAttribute('y', P[key].p.y+2.5); t.setAttribute('class','label');
  // slightly smaller font for dense head cluster
  if(P[key].p.y/H < 0.20){ t.setAttribute('font-size','3.8px'); }
  t.setAttribute('text-anchor', side==='left'?'start':'end');
  t.textContent=HUMAN_LABEL(key);
  g.appendChild(t);
  return {g,dot,t};
}
layer.innerHTML='';
[...LEFT_KEYS,...RIGHT_KEYS].forEach(k=>{const side=LEFT_KEYS.includes(k)?'left':'right'; nodes[k]=makeNode(k,side); layer.appendChild(nodes[k].g);});
function stack(keys,side){
  keys.sort((a,b)=>P[a].p.y-P[b].p.y);
  let y=null; let col=0;
  const COL_STEP=10; // px shift per column
  keys.forEach(k=>{
    let yy=P[k].p.y+2.5;
    const gap = (P[k].p.y/H < 0.20) ? MIN_GAP_HEAD : MIN_GAP;
    if(y!==null && yy<y+gap) yy=y+gap;
    // stagger 3 columns per side
    const dx = (col%3)*COL_STEP;
    const base = (side==='left'?LEFT_COL:RIGHT_COL);
    const x = side==='left'? (base + dx) : (base - dx);
    nodes[k].t.setAttribute('y',yy);
    nodes[k].t.setAttribute('x',x);
    y=yy; col++;
  });
}
stack([...LEFT_KEYS],'left'); stack([...RIGHT_KEYS],'right');
const ALL_KEYS=[...new Set([...LEFT_KEYS,...RIGHT_KEYS])];

// Soft-grey reset + no sticky lights
function resetAll(){
  ALL_KEYS.forEach(k=>{
    const n=nodes[k]; if(!n) return;
    n.g.classList.remove('dim');
    n.dot.setAttribute('fill','var(--off)'); // soft grey
    n.dot.classList.remove('flash-dot'); n.t.classList.remove('flash-label');
    n.t.classList.remove('inactiveLabel'); n.dot.classList.remove('inactiveDot');
  });
}
function lightOnly(keys){
  resetAll();
  const set=new Set(keys);
  ALL_KEYS.forEach(k=>{
    const n=nodes[k]; if(!n) return;
    const off = !set.has(k);
    n.g.classList.toggle('dim', off);
    if(off){ n.t.classList.add('inactiveLabel'); n.dot.classList.add('inactiveDot'); }
    else{ n.t.classList.remove('inactiveLabel'); n.dot.classList.remove('inactiveDot'); }
  });
}
function flash(keys){
  keys.forEach(k=>{
    const n=nodes[k]; if(!n) return;
    n.dot.classList.remove('flash-dot'); n.t.classList.remove('flash-label');
    void n.dot.offsetWidth; n.dot.classList.add('flash-dot'); n.t.classList.add('flash-label');
  });
}

/* ---------------------------- Seven Spirits + Fruits ‚Üí rainbow ---------------------------- */
const SPIRITS = [
  {id:'Lord',        color:'#ff1744'}, // vivid red
  {id:'Wisdom',      color:'#ff9100'}, // vivid orange
  {id:'Understanding',color:'#ffea00'}, // bright yellow
  {id:'Counsel',     color:'#00e676'}, // vivid green
  {id:'Might',       color:'#2979ff'}, // vivid blue
  {id:'Knowledge',   color:'#651fff'}, // vivid indigo
  {id:'Fear',        color:'#d500f9'}  // vivid violet
];
const FRUITS = {
  love:'Lord', joy:'Wisdom', peace:'Understanding', patience:'Counsel',
  kindness:'Counsel', goodness:'Might', faithfulness:'Knowledge', gentleness:'Fear', selfcontrol:'Fear'
};
const SPIRIT_LEX = [
  {sp:'Lord', rx:/\b(name|lord|holy|glory|worship|throne|king|almighty|hallelujah)\b/i},
  {sp:'Wisdom', rx:/\b(wisdom|wise|skill|craft|teach|learn|consider)\b/i},
  {sp:'Understanding', rx:/\b(understand|discern|light|reveal|meaning|parables?)\b/i},
  {sp:'Counsel', rx:/\b(counsel|guide|advise|plan|purpose|covenant|comfort)\b/i},
  {sp:'Might', rx:/\b(might|power|strength|arm|hand|war|fight|overcome|stand)\b/i},
  {sp:'Knowledge', rx:/\b(know|knowledge|remember|testify|witness|truth)\b/i},
  {sp:'Fear', rx:/\b(fear|awe|tremble|revere|holy|righteous)\b/i}
];
function legendRender(){
  const el=document.getElementById('legend'); el.innerHTML='';
  SPIRITS.forEach(s=>{
    const d=document.createElement('div'); d.className='pill';
    d.innerHTML='<span class="swatch" style="background:'+s.color+'"></span>'+s.id;
    el.appendChild(d);
  });
}
legendRender();

// Gate default color map (top‚Üíbottom rainbow as stable fallback)
const GATE_COLOR = {
  crown:'Fear', pituitary:'Knowledge', pineal:'Knowledge', mind:'Knowledge', face:'Knowledge', eyeL:'Knowledge', eyeR:'Knowledge', earL:'Knowledge', earR:'Knowledge',
  nose:'Understanding', mouth:'Counsel', tongue:'Counsel', jaw:'Counsel', thyroid:'Counsel', larynx:'Counsel', trachea:'Counsel', esophagus:'Counsel', neck:'Counsel',
  chest:'Might', lungs:'Understanding', ribsL:'Might', ribsR:'Might', heart:'Lord', diaphragm:'Understanding',
  solar:'Wisdom', liver:'Might', spleen:'Understanding', pancreas:'Wisdom', adrenalL:'Might', adrenalR:'Might',
  leftKid:'Understanding', rightKid:'Understanding', gut:'Wisdom', intestine:'Wisdom', colon:'Wisdom', bladder:'Wisdom',
  spine:'Counsel', cervN:'Counsel', lumbN:'Counsel', sacN:'Counsel',
  shL:'Might', shR:'Might', elbowL:'Might', elbowR:'Might', wristL:'Might', wristR:'Might',
  handL:'Might', handR:'Might', medianL:'Might', medianR:'Might', ulnarL:'Might', ulnarR:'Might', radialL:'Might', radialR:'Might',
  hipL:'Wisdom', hipR:'Wisdom', pelvis:'Wisdom',
  kneeL:'Wisdom', kneeR:'Wisdom', tibialL:'Wisdom', tibialR:'Wisdom', peronealL:'Wisdom', peronealR:'Wisdom',
  ankleL:'Wisdom', ankleR:'Wisdom', footL:'Wisdom', footR:'Wisdom', sciL:'Might', sciR:'Might'
};

function spiritFor(text){
  // Fruits override if explicit
  const f = Object.keys(FRUITS).find(k=> new RegExp('\\b'+k+'\\b','i').test(text.replace(/\s+/g,'')) || new RegExp('\\b'+k+'\\b','i').test(text));
  if(f){ return FRUITS[f]; }
  const hit = SPIRIT_LEX.find(s=>s.rx.test(text));
  return hit ? hit.sp : 'Counsel'; // default
}
function applyColors(keys, colorByKey){
  keys.forEach(k=>{
    const n=nodes[k]; if(!n) return;
    const sp = colorByKey[k] || GATE_COLOR[k] || 'Counsel';
    const color = (SPIRITS.find(s=>s.id===sp)||SPIRITS[3]).color;
    n.dot.setAttribute('fill', color);
  });
}

/* ---------------------------- Math Engine v1 ---------------------------- */
const AZ='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
const A1Z26 = ch => { const i=AZ.indexOf(ch.toUpperCase()); return i>=0? i+1 : 0; };
function tokenize(text){
  const tokens=[]; let buf='';
  for(const ch of text){
    if(/[A-Za-z]/.test(ch)){ buf+=ch; }
    else{ if(buf){ tokens.push({type:'word',v:buf}); buf=''; }
      if(/\d/.test(ch) || /\s/.test(ch)) continue;
      tokens.push({type:'punc',v:ch});
    }
  }
  if(buf) tokens.push({type:'word',v:buf}); return tokens;
}
function wordSum(w){ return w.split('').reduce((a,c)=>a+A1Z26(c),0); }
function toDNA(nums){
  const map=['T','A','C','G']; const bases = nums.map(n=>map[n%4]);
  const counts = {A:0,C:0,G:0,T:0}; bases.forEach(b=>counts[b]++);
  const quads=[]; for(let i=0;i+3<bases.length && quads.length<3;i++){ quads.push(bases.slice(i,i+4).join('')); }
  return {bases,counts,quads};
}

/* ---------- Stable Weighted Engine (v1.7) ‚Äî returns organs + per-organ spirit hints ---------- */
const NEG_RX = /\b(no|not|without|never|hardly|scarcely|ain't|isn't|wasn't|don't|doesn't|won't|can't)\b/i;
const AMP_RX = /\b(very|really|so|extremely|severely|deeply|intensely|awfully|terribly|a\s*lot|too\s*much|often|frequently)\b/i;
const LEFT_HINT = /\bleft\b/i, RIGHT_HINT = /\bright\b/i;

function mkRule(rx,on,w,sp){ return {rx,on,w,sp}; }

const SYMPTOMS = [
  mkRule(/\b(cough|coughing|hack|phlegm|dry\s*cough|productive\s*cough)\b/i,['larynx','lungs'],7,'Counsel'),
  mkRule(/\b(wheeze|asthma|short(ness)?\s*of\s*breath|dyspnea|can.?t\s*(breathe|catch\s*my\s*breath)|gasp(ing)?)\b/i,['lungs','chest'],8,'Understanding'),
  mkRule(/\b(sore\s*throat|hoarse|laryngitis|scratchy\s*throat)\b/i,['larynx'],7,'Counsel'),
  mkRule(/\b(runny|stuffy)\s*nose|congestion|sinus(itis)?|sinus\s*pressure\b/i,['face','lungs'],5,'Understanding'),
  mkRule(/\b(chest\s*(pain|tight(ness)?|pressure|heav(y|iness)))\b/i,['chest','heart','lungs'],7,'Might'),
  mkRule(/\b(palpitations?|heart\s*(racing|pounding|flutter(ing)?))\b/i,['heart','chest'],7,'Lord'),
  mkRule(/\b(nausea|nauseous|queasy|vomit|throw\s*up|retch|sick\s*to\s*my\s*stomach)\b/i,['gut','solar'],8,'Wisdom'),
  mkRule(/\b(diarrhea|constipation|stomach\s*ache|cramps?|bloating|gas)\b/i,['gut','intestine','colon'],6,'Wisdom'),
  mkRule(/\b(heartburn|acid\s*reflux|indigestion)\b/i,['gut','solar'],6,'Wisdom'),
  mkRule(/\b(appetite|hungry|no\s*appetite|loss\s*of\s*appetite)\b/i,['gut','pancreas'],5,'Wisdom'),
  mkRule(/\b(fever|feverish|chills)\b/i,['spleen'],4,'Understanding'),
  mkRule(/\b(fatigue|tired|exhaust(ed|ion)|drained|weak)\b/i,['spleen','adrenalL','adrenalR'],4,'Might'),
  mkRule(/\b(headache|migraine|head\s*pain|throb)\b/i,['mind','face'],6,'Knowledge'),
  mkRule(/\b(dizzy|dizziness|vertigo|lighthead)\b/i,['mind'],6,'Knowledge'),
  mkRule(/\b(jaw\s*(clench|pain|tight|tmj))\b/i,['jaw','mouth','tongue'],6,'Counsel'),
  mkRule(/\b(back\s*pain|stiff\s*back|sciatica)\b/i,['spine','sciL','sciR'],6,'Counsel'),
  mkRule(/\b(shoulder\s*pain|frozen\s*shoulder|burden|yoke)\b/i,['shL','shR','spine'],5,'Might'),
  mkRule(/\b(hip\s*pain)\b/i,['hipL','hipR','pelvis'],5,'Wisdom'),
  mkRule(/\b(kidney|renal|flank\s*pain|burning\s*urine)\b/i,['leftKid','rightKid','bladder'],6,'Understanding'),
  mkRule(/\b(itch|itchy|rash|hives)\b/i,['face','handL','handR'],3,'Knowledge'),
  mkRule(/\b(breathe|breathing|breath|winded)\b/i,['lungs','diaphragm'],4,'Understanding')
];

const FEELINGS = [
  mkRule(/\b(anxious|anxiety|nervous|on\s*edge|worried|uneasy|panic)\b/i,['gut','chest','lungs','mind'],6,'Knowledge'),
  mkRule(/\b(sad|sadness|down|blue|grief|lonely|depressed)\b/i,['heart','face','mind'],6,'Lord'),
  mkRule(/\b(angry|anger|furious|irritated|frustrated|rage)\b/i,['jaw','face','chest','handL','handR','shL','shR'],6,'Might'),
  mkRule(/\b(shame|ashamed|embarrassed)\b/i,['face','gut','heart'],6,'Understanding'),
  mkRule(/\b(guilt|guilty|regret|remorse)\b/i,['heart','gut'],6,'Counsel'),
  mkRule(/\b(joy|glad|delight|rejoice|grateful|gratitude)\b/i,['heart','face','lungs'],5,'Wisdom'),
  mkRule(/\b(calm|peace|at\s*peace|still|grounded)\b/i,['lungs','spine','heart'],5,'Understanding'),
  mkRule(/\b(hope|faith|trust|surrender)\b/i,['heart','spine'],5,'Knowledge'),
  mkRule(/\b(disgust|gross|nauseated)\b/i,['gut','face'],5,'Wisdom'),
  mkRule(/\b(surprise|startled|shocked)\b/i,['chest','mind','face'],4,'Knowledge')
];

const DIRECT = [
  mkRule(/\b(eye|eyes)\b/i,['eyeL','eyeR'],9,'Knowledge'),
  mkRule(/\b(ear|ears)\b/i,['earL','earR'],9,'Knowledge'),
  mkRule(/\b(mouth|tongue)\b/i,['mouth','tongue','larynx'],9,'Counsel'),
  mkRule(/\b(throat|larynx|voice)\b/i,['larynx','mouth','neck','thyroid','trachea','esophagus'],9,'Counsel'),
  mkRule(/\b(chest|bosom|breast)\b/i,['chest','lungs','heart','diaphragm','ribsL','ribsR'],9,'Might'),
  mkRule(/\b(nose|nostril|sinus|congestion|sinuses)\b/i,['nose','face','lungs'],9,'Understanding'),
  mkRule(/\b(diaphragm)\b/i,['diaphragm','lungs'],9,'Understanding'),
  mkRule(/\b(heart)\b/i,['heart','chest'],10,'Lord'),
  mkRule(/\b(lung|lungs|breath|breathe|breathing|air)\b/i,['lungs','diaphragm'],9,'Understanding'),
  mkRule(/\b(stomach|belly|tummy|abdomen|gut|bowels)\b/i,['gut','pancreas','solar','intestine','colon'],9,'Wisdom'),
  mkRule(/\b(liver|gall)\b/i,['liver'],9,'Might'),
  mkRule(/\b(kidney|renal|kidneys)\b/i,['leftKid','rightKid'],9,'Understanding'),
  mkRule(/\b(pelvis|womb)\b/i,['pelvis','hipL','hipR','bladder'],9,'Wisdom'),
  mkRule(/\b(hip)\b/i,['hipL','hipR','pelvis'],9,'Wisdom'),
  mkRule(/\b(back|spine|backbone)\b/i,['spine','cervN','lumbN','sacN'],9,'Counsel'),
  mkRule(/\b(shoulder)\b/i,['shL','shR'],9,'Might'),
  mkRule(/\b(elbow)\b/i,['elbowL','elbowR'],9,'Might'),
  mkRule(/\b(wrist)\b/i,['wristL','wristR'],9,'Might'),
  mkRule(/\b(hand|hands?)\b/i,['handL','handR'],9,'Might'),
  mkRule(/\b(knee|knees?)\b/i,['kneeL','kneeR'],9,'Wisdom'),
  mkRule(/\b(ankle|ankles?)\b/i,['ankleL','ankleR'],9,'Wisdom'),
  mkRule(/\b(foot|feet|toe|toes)\b/i,['footL','footR','ankleL','ankleR'],9,'Wisdom'),
  mkRule(/\b(eye|eyes)\b/i,['eyeL','eyeR'],9,'Knowledge')
];

function scoreOrgansWithSpirits(text){
  const scores = {}; const spHints={}; const add=(k,w,sp)=>{
    scores[k]=(scores[k]||0)+w; if(sp){ (spHints[k]||(spHints[k]={}))[sp]=(spHints[k][sp]||0)+1; }
  };
  const neg = NEG_RX.test(text);
  const amp = AMP_RX.test(text) ? 1.25 : 1.0;
  const leftH = LEFT_HINT.test(text), rightH = RIGHT_HINT.test(text);

  const ALL_RULES=[...DIRECT,...SYMPTOMS,...FEELINGS];
  ALL_RULES.forEach(r=>{ if(r.rx.test(text)){ r.on.forEach(k=> add(k, (neg? r.w*0.7 : r.w)*amp, r.sp)); }});

  if(leftH){ ['eyeL','earL','handL','wristL','elbowL','kneeL','ankleL','footL','hipL','leftKid','shL','sciL','medianL','ulnarL','radialL','peronealL','tibialL'].forEach(k=> add(k,1.2*amp)); }
  if(rightH){ ['eyeR','earR','handR','wristR','elbowR','kneeR','ankleR','footR','hipR','rightKid','liver','shR','sciR','medianR','ulnarR','radialR','peronealR','tibialR'].forEach(k=> add(k,1.2*amp)); }

  // Baseline
  add('heart', 0.8, 'Lord');

  const ranked = Object.entries(scores).sort((a,b)=>b[1]-a[1]);
  const top = ranked.filter(([k,w])=> w>=1.6).slice(0,16).map(([k])=>k);
  const colorByKey={};
  top.forEach(k=>{
    const bag = spHints[k]||{};
    let bestSp = Object.entries(bag).sort((a,b)=>b[1]-a[1])[0]?.[0];
    if(!bestSp){ bestSp = null; } // will fall back to gate
    colorByKey[k]=bestSp||GATE_COLOR[k]||'Counsel';
  });
  return {organs: (top.length? top : ['heart']), colorByKey};
}

function organsFor(text){ return scoreOrgansWithSpirits(text); }

function mathFor(text){
  const toks=tokenize(text);
  const words=toks.filter(t=>t.type==='word').map(t=>t.v);
  const nums=words.map(w=>wordSum(w));
  const total = nums.reduce((a,b)=>a+b,0);
  const dna = toDNA(nums);
  return {words, nums, total, dna, toks};
}

/* ---------------------------- Data + rendering ---------------------------- */
const RP = {
  title:document.getElementById('title'), ref:document.getElementById('ref'), seal:document.getElementById('seal'),
  orig:document.getElementById('orig'), anatomy:document.getElementById('anatomy'), explain:document.getElementById('explain'),
  sumWords:document.getElementById('sumWords'), dnaCounts:document.getElementById('dnaCounts'), dnaQuads:document.getElementById('dnaQuads'),
  srcLabel:document.getElementById('srcLabel')
};
const crumb=document.getElementById('crumb');
let BOOK={title:'', verses:[]};
let curBookIdx = BOOK_NAMES.indexOf('Revelation');
let curChapter = 1;
let verseIdx=0;
let currentSource='web';

const DEFAULT_TAIL = " ‚Ä¢ Default: It‚Äôs not what you‚Äôre doing, but why you‚Äôre doing it. As Jesus taught, it isn‚Äôt what goes into a person that defiles, but what comes out from the heart (cf. Matthew 15:11). Choices are allowable in spirit‚Äîbut consequences play out in this world. Let‚Äôs choose from love.";

function explainFor(on, patternSummary){
  const msg=[];
  if(on.includes('mind')) msg.push('Quiet your mind: write what you notice, not what you fear.');
  if(on.includes('earL')||on.includes('earR')) msg.push('Listen fully before you answer. Let the noise pass; keep the signal.');
  if(on.includes('mouth')||on.includes('larynx')) msg.push('Speak plainly and kindly. Short, clean sentences.');
  if(on.includes('heart')) msg.push('Breathe slow. Hand on chest‚Äîname what you love, not what you lack.');
  if(on.includes('lungs')) msg.push('Inhale 4, hold 4, exhale 6. Do three rounds.');
  if(on.includes('handL')||on.includes('handR')) msg.push('Do one small faithful action: write, bless, repair, or serve.');
  if(on.includes('eyeL')||on.includes('eyeR')) msg.push('Lift your eyes. Reframe what you see in the light of promise.');
  if(on.includes('footL')||on.includes('footR')) msg.push('Stand steady. Take one honest step‚Äîno rush.');
  if(on.includes('spine')) msg.push('Straighten your spine; remember who holds you together.');
  if(on.includes('chest')) msg.push('Square your chest. Wear peace like a sash.');
  if(on.includes('crown')) msg.push('Your beginning and end are held; wear that like a crown.');
  if(on.includes('gut')) msg.push('Unclench gently. Sip water. Tell your body, ‚ÄúWe are safe.‚Äù');
  if(on.includes('liver')) msg.push('Release bitterness; choose a clean story.');
  if(on.includes('leftKid')||on.includes('rightKid')) msg.push('Filter what you keep; let the rest pass.');
  if(on.includes('pelvis')) msg.push('Ground yourself; sway gently, reconnect to support.');
  if(on.includes('spleen')||on.includes('pancreas')) msg.push('Nourish steadily; choose steady fuel, not spikes.');
  if(patternSummary){ msg.push('I notice a pattern: '+patternSummary); }
  if(on.length===0 && msg.length===0) msg.push('Be still. Notice, then choose the next faithful action.');
  return (msg.join(' ') + ' ' + DEFAULT_TAIL).trim();
}

function renderVerse(){
  const V=BOOK.verses[verseIdx]||{ref:'‚Äî', text:'‚Äî'};
  RP.title.textContent=BOOK.title||'‚Äî';
  RP.ref.textContent=V.ref||'‚Äî';
  RP.seal.textContent='Seal: ‚Äî';
  RP.orig.textContent=V.text||'‚Äî';

  const m=mathFor(V.text||'');
  let {organs:on, colorByKey} = organsFor(V.text||'');
  if(on.length<2){ const seed = (V.ref||'') + '|' + (V.text||''); const extra = deterministicAnchors(seed, 2-on.length+1); on = Array.from(new Set(on.concat(extra))); }
  RP.anatomy.textContent = on.map(k=>HUMAN_LABEL(k)).join(' ‚Ä¢ ');
  RP.explain.textContent = explainFor(on, patternSummaryFromHistory(6)); // adapt to recent pattern

  RP.sumWords.textContent = `${m.total} (from ${m.words.length} words)`;
  RP.dnaCounts.textContent = `A:${m.dna.counts.A} C:${m.dna.counts.C} G:${m.dna.counts.G} T:${m.dna.counts.T}`;
  RP.dnaQuads.textContent = m.dna.quads.join(' ‚Ä¢ ') || '‚Äî';
  crumb.textContent = `${BOOK.title} ‚Ä¢ ${V.ref}`;

  lightOnly(on); applyColors(on, colorByKey); flash(on);
}

/* ---------------------------- Loaders ---------------------------- */
async function loadFromWeb(book, chapter){
  const q = encodeURIComponent(`${book} ${chapter}`);
  const url = `https://bible-api.com/${q}?translation=web`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('web fetch failed');
  const j = await res.json();
  const verses = (j.verses||[]).map(v=>({ref:`${v.chapter}:${v.verse}`, text: (v.text||'').trim()}));
  return {title:`${book} ${chapter}`, verses};
}
async function loadFromLocal(book, chapter){
  const slug = `${book.toLowerCase()}-${chapter}`.replace(/\s+/g,'-');
  const url = `data/${slug}.json`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('local fetch failed');
  const j = await res.json();
  const verses = Array.isArray(j)? j : (j.verses || j.chapter || []);
  const mapped = verses.map(v=>({ref: v.ref || v.reference || '?:?', text:(v.text || v.orig || '').trim()}));
  return {title:`${book} ${chapter}`, verses:mapped};
}
async function loadChapter(bookIdx, chapter, source=currentSource){
  currentSource = source;
  const book = BOOK_NAMES[bookIdx];
  const max = CANON[bookIdx][1];
  const ch = Math.min(Math.max(1, Number(chapter)||1), max);
  RP.srcLabel.textContent = source==='web' ? 'WEB via bible-api.com' : 'Local JSON (/data)';
  try{
    BOOK = source==='web' ? await loadFromWeb(book,ch) : await loadFromLocal(book,ch);
    curBookIdx = bookIdx; curChapter = ch; verseIdx=0; renderVerse();
  }catch(e){
    if(source==='web'){
      RP.srcLabel.textContent = 'Local JSON (/data) ‚Äî (web failed, fell back)';
      try{ BOOK = await loadFromLocal(book,ch); curBookIdx=bookIdx; curChapter=ch; verseIdx=0; renderVerse(); return; }catch(_){}
    }else{
      RP.srcLabel.textContent = 'WEB via bible-api.com ‚Äî (local failed, fell back)';
      try{ BOOK = await loadFromWeb(book,ch); curBookIdx=bookIdx; curChapter=ch; verseIdx=0; renderVerse(); return; }catch(_){}
    }
    alert('Could not load chapter from web or local.');
  }
}

/* ---- Global next/prev (verses ‚Üí chapters ‚Üí books) ---- */
async function goNext(){
  stopAuto();
  if(verseIdx+1 < (BOOK.verses.length||0)){ verseIdx++; renderVerse(); return; }
  const [_,maxCh] = CANON[curBookIdx];
  if(curChapter < maxCh){ await loadChapter(curBookIdx, curChapter+1); return; }
  if(curBookIdx+1 < CANON.length){ await loadChapter(curBookIdx+1, 1); return; }
  await loadChapter(0,1);
}
async function goPrev(){
  stopAuto();
  if(verseIdx > 0){ verseIdx--; renderVerse(); return; }
  if(curChapter > 1){ await loadChapter(curBookIdx, curChapter-1); verseIdx=(BOOK.verses.length||1)-1; renderVerse(); return; }
  if(curBookIdx > 0){ const prevIdx = curBookIdx-1; const lastCh = CANON[prevIdx][1]; await loadChapter(prevIdx, lastCh); verseIdx=(BOOK.verses.length||1)-1; renderVerse(); return; }
  const lastIdx = CANON.length-1; await loadChapter(lastIdx, CANON[lastIdx][1]); verseIdx=(BOOK.verses.length||1)-1; renderVerse();
}

/* ---------------------------- Controls ---------------------------- */
const g = (id)=>document.getElementById(id);
// populate book select
(function initBooks(){
  const sel=g('bookSel');
  BOOK_NAMES.forEach((n,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=n; sel.appendChild(o); });
  sel.value = BOOK_NAMES.indexOf('Revelation');
})();
g('load').onclick=()=>{ loadChapter(Number(g('bookSel').value), Number(g('chapter').value)||1, g('src').value); };
g('next').onclick=goNext; g('prev').onclick=goPrev;

let auto=null;
function stopAuto(){ if(auto){ clearTimeout(auto); auto=null; g('play').textContent='‚ñ∂Ô∏é Play'; } }
function startAuto(){
  g('play').textContent='‚ùö‚ùö Pause';
  const run=()=>{ goNext(); const ms=Math.max(3, Number(g('interval').value)||10)*1000; auto=setTimeout(run, ms); };
  run();
}
g('play').onclick=()=>{ if(auto){ stopAuto(); } else { startAuto(); } };

/* ---------------------------- Free text: history + patterns ---------------------------- */
const historyEl = g('history');
const patternOut = g('patternOut');
const history=[]; // {t, text, organs, spirit, total, dna, quads}

function renderHistory(){
  historyEl.innerHTML = history.slice(-25).map((h,i)=>{
    const labs = h.organs.map(k=>`<span class="pill">${HUMAN_LABEL(k)}</span>`).join(' ');
    return `<div class="hist-item">
      <div class="small" style="min-width:54px;opacity:.7">${new Date(h.t).toLocaleTimeString()}</div>
      <div class="small" style="flex:1">
        <div>${h.text.replace(/</g,'&lt;')}</div>
        <div style="margin-top:4px">${labs}</div>
      </div>
      <div class="small" style="min-width:86px;text-align:right;opacity:.7">${h.note||''}</div>
    </div>`;
  }).join('');
}

function patternSummaryFromHistory(lastN=10){
  const slice = history.slice(-lastN);
  if(slice.length<3) return '';
  const counts = {}; // organ -> freq
  slice.forEach(h=> h.organs.forEach(o=> counts[o]=(counts[o]||0)+1 ));
  const top = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,3);
  if(top.length===0) return '';
  const msg = top.map(([k,c])=> `${HUMAN_LABEL(k)}√ó${c}`).join(', ');
  return `recent emphasis at ${msg}.`;
}

function deterministicAnchors(seed, n=2){
  const keys = ALL_KEYS.filter(k=>k!=='heart');
  let x = 0; for(let i=0;i<seed.length;i++){ x = (x*31 + seed.charCodeAt(i)) % 1000003; }
  const out=[]; for(let i=0;i<n;i++){ x=(x*131+17)%keys.length; out.push(keys[x]); }
  return out;
}

function runFree(){
  const t = g('freeText').value.trim();
  if(!t){ g('freeMath').textContent='(type something first)'; return; }
  const m = mathFor(t);
  let {organs:on, colorByKey} = organsFor(t);
  if(on.length===1 && on[0]==='heart'){ const extra = deterministicAnchors(t,2); on = Array.from(new Set(on.concat(extra))); }
  const spiritNote = Object.values(colorByKey).slice(0,5).join(', ');
  g('freeMath').textContent = `Œ£=${m.total} ‚Ä¢ DNA A:${m.dna.counts.A} C:${m.dna.counts.C} G:${m.dna.counts.G} T:${m.dna.counts.T} ‚Ä¢ ${m.dna.quads.join(' ‚Ä¢ ')||'‚Äî'}`;
  lightOnly(on); applyColors(on, colorByKey); flash(on);
  RP.explain.textContent = explainFor(on, patternSummaryFromHistory(10));
  history.push({t:Date.now(), text:t, organs:on, note:spiritNote, total:m.total, dna:m.dna.counts, quads:m.dna.quads});
  renderHistory();
  g('freeText').value='';
}
g('freeGo').onclick=runFree;
g('freeText').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); runFree(); }});
g('patternBtn').onclick=()=>{
  const summary = patternSummaryFromHistory(15);
  patternOut.textContent = summary ? `Pattern: ${summary}` : 'No clear pattern yet ‚Äî keep reflecting.';
};

/* ---------------------------- TTS (Web Speech API) ---------------------------- */
const voiceSel=g('voice'); const rate=g('rate'); let voices=[];
function loadVoices(){
  voices = speechSynthesis.getVoices().filter(v=>v.lang.startsWith('en'));
  voiceSel.innerHTML='';
  voices.forEach((v,i)=>{ const o=document.createElement('option'); o.value=String(i); o.textContent=`${v.name} ‚Ä¢ ${v.lang}`; voiceSel.appendChild(o); });
  const z=voices.findIndex(v=>/Google US English|Samantha|Daniel|Alex/i.test(v.name));
  voiceSel.value = String(z>=0? z : 0);
}
loadVoices(); speechSynthesis.onvoiceschanged = loadVoices;
function speak(text){ if(!text) return; speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); const v = voices[Number(voiceSel.value)||0]; if(v) u.voice=v; u.rate = Number(rate.value)||1; speechSynthesis.speak(u); }
document.getElementById('speakVerse').onclick=()=>{ speak(RP.orig.textContent); };
document.getElementById('speakExplain').onclick=()=>{ speak(RP.explain.textContent); };
document.getElementById('speakFree').onclick=()=>{ speak(RP.explain.textContent); };

/* ---------------------------- Init ---------------------------- */
// initial load Revelation 1
(function init(){
  // ensure legend exists
  legendRender();
  // start at Revelation 1
  loadChapter(BOOK_NAMES.indexOf('Revelation'),1,'web');
})();

// === Voice dictation via Web Speech API (Chrome/Edge) ===
(function(){
  const mic = document.getElementById('micBtn');
  const input = document.getElementById('freeText');
  const goBtn = document.getElementById('freeGo');
  if(!mic || !input) return;
  let recognizing = false;
  let rec;
  function ensureRec(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR) return null;
    const r = new SR();
    r.lang = 'en-US';
    r.interimResults = true;
    r.continuous = true;
    return r;
  }
  mic.addEventListener('click', ()=>{
    if(recognizing){
      recognizing=false;
      try{ rec.stop(); }catch(e){}
      mic.textContent='üéôÔ∏è Speak';
      mic.classList.remove('active');
      input.focus();
    }else{
      rec = ensureRec();
      if(!rec){ alert('Speech recognition not supported on this device/browser.'); return; }
      recognizing=true;
      mic.textContent='‚ñ† Stop';
      mic.classList.add('active');
      input.value='';
      rec.onresult = (e)=>{
        let s='';
        for(let i=e.resultIndex;i<e.results.length;i++){
          s += e.results[i][0].transcript;
        }
        input.value = s.trim();
      };
      rec.onend = ()=>{
        if(recognizing){ // unexpected end, try to restart
          try{ rec.start(); }catch(e){}
        }
      };
      try{ rec.start(); }catch(e){}
    }
  });
  // Allow Enter to submit as before
  input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){
      e.preventDefault();
      if(recognizing){ try{ rec.stop(); }catch(_){} recognizing=false; mic.textContent='üéôÔ∏è Speak'; mic.classList.remove('active'); }
      if(goBtn) goBtn.click();
    }
  });
})();
</script>

<!-- Echo Sticky Mobile Dock (additive) -->
<footer id="echoDock" aria-label="Quick chat (mobile)">
  <div class="bar">
    <button id="echoMic" class="btn" title="Speak">üéôÔ∏è</button>
    <input id="echoInput" placeholder="Type or talk‚Ä¶" autocomplete="off" />
    <button id="echoSend" class="btn" title="Send">‚û§</button>
  </div>
</footer>
<button id="echoMore" class="echoHideDesktop" style="display:none">More</button>

<script>
// === Echo Mobile JS (non-destructive) ===
(function(){
  const isMobile = ()=> window.matchMedia('(max-width: 820px)').matches;

  // Show the 'More' pill on mobile to toggle extras
  const more = document.getElementById('echoMore');
  function toggleMoreVis(){ if(more) more.style.display = isMobile() ? 'block' : 'none'; }
  toggleMoreVis(); window.addEventListener('resize', toggleMoreVis);
  if(more){ more.onclick = ()=> document.body.classList.toggle('echoShowExtras'); }

  // Wire the dock to your existing input/send
  const dockIn  = document.getElementById('echoInput');
  const dockBtn = document.getElementById('echoSend');
  const dockMic = document.getElementById('echoMic');

  const mainInput = document.getElementById('input') || document.querySelector('input[type="text"], input:not([type])');
  const mainSend  = document.getElementById('send')  || document.querySelector('[data-action="send"], button#send');

  function forwardSend(){
    const t = (dockIn.value||'').trim(); if(!t) return;
    if(mainInput) mainInput.value = t;
    dockIn.value = '';
    if(mainSend){ mainSend.click(); }
    else if(typeof window.send === 'function'){ window.send(); }
    else if(typeof window.composeReply === 'function'){ // graceful fallback
      try{
        if(typeof window.addUser==='function') window.addUser(t);
        const res = window.composeReply(t) || {};
        const text = (typeof res==='string')?res:(res.text||"I'm here.");
        const gate = res.gate || '';
        if(typeof window.addAssistantStreamed==='function'){ window.addAssistantStreamed('Listening‚Ä¶', text, gate); }
        if(typeof window.lightBody==='function' && gate){ window.lightBody(gate); speak(text); }
        else { speak(text); }
      }catch(e){ console.warn(e); }
    }
    try{ window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); }catch(e){}
  }
  if(dockBtn) dockBtn.addEventListener('click', forwardSend);
  if(dockIn)  dockIn.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); forwardSend(); }});

  // Voice to text
  let rec, listening=false;
  function canVoice(){ return 'webkitSpeechRecognition' in window; }
  function toggleMic(){
    if(!canVoice()){ alert('Voice input not supported on this device/browser.'); return; }
    if(listening){ rec.stop(); return; }
    rec = new webkitSpeechRecognition();
    rec.lang='en-US'; rec.interimResults=true; rec.continuous=false;
    rec.onresult=(e)=>{
      let final='';
      for(let i=e.resultIndex;i<e.results.length;i++){
        const chunk=e.results[i][0].transcript;
        if(e.results[i].isFinal) final+=chunk; else dockIn.value=(dockIn.value+' '+chunk).trim();
      }
      if(final) dockIn.value=(dockIn.value+' '+final).trim();
    };
    rec.onend=()=>{ listening=false; if(dockMic) dockMic.textContent='üéôÔ∏è'; if(dockIn.value.trim()) forwardSend(); };
    rec.onerror=()=>{ listening=false; if(dockMic) dockMic.textContent='üéôÔ∏è'; };
    listening=true; if(dockMic) dockMic.textContent='‚èπ'; rec.start();
  }
  if(dockMic) dockMic.addEventListener('click', toggleMic);

  // Auto TTS speak for latest assistant output when "Light" buttons are clicked
  function speak(text){
    try{
      if(!('speechSynthesis' in window) || !text) return;
      const u = new SpeechSynthesisUtterance(text);
      u.rate=1; u.pitch=1; u.volume=1;
      speechSynthesis.cancel(); speechSynthesis.speak(u);
    }catch(e){}
  }
  let lastAssistantText = "";
  // If your app appends assistant text somewhere, you can call window.echoSetAssistant(text)
  window.echoSetAssistant = function(t){ lastAssistantText = t||''; };
  document.addEventListener('click', (e)=>{
    const el = e.target.closest('#light, .lightIt, [data-action="light"], #Light, #lightIt');
    if(el && lastAssistantText){ speak(lastAssistantText); }
  });

  // Optional conversational API: call /api/chat if available. To enable, set window.ECHO_USE_CHAT_API=true.
  window.ECHO_USE_CHAT_API = window.ECHO_USE_CHAT_API ?? false;
  if(window.ECHO_USE_CHAT_API){
    // Intercept your main send if possible to fetch a reply
    const origSend = (typeof window.send==='function') ? window.send : null;
    window.send = async function(){
      if(origSend) origSend();
      try{
        const userText = (mainInput && mainInput.value) ? mainInput.value : (dockIn && dockIn.value) ? dockIn.value : '';
        if(!userText) return;
        const res = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({messages:[{role:'user', content:userText}]}) });
        const j = await res.json();
        const reply = j.reply || '';
        if(reply){
          // Try to display using your existing renderer
          if(typeof window.addAssistantStreamed==='function'){ window.addAssistantStreamed('Echo', reply, ''); }
          else {
            // As a fallback, alert or console
            console.log('Echo:', reply);
          }
          lastAssistantText = reply;
          speak(reply);
        }
      }catch(e){ console.warn(e); }
    };
  }
})();
</script>

</body>
</html>
